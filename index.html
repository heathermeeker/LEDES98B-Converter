
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bananafoot LEDES Converter</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding-top: 20px;
            padding-bottom: 20px;
            font-size: 14px;
        }

        .form-control {
            font-size: 14px;
        }

        .line-item {
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #f8f9fa;
        }
    </style>
</head>

<body>
    <div class="container">
        <h2 class="mb-4">Bananafoot LEDES Converter</h2>
        <h3 class="text-muted mb-4"><i>"Bananafoot: Making your law practice slightly less tedious"</i></h3>
        <p class="mb-4">This program allows you to enter information to create a LEDES 1998B billing file. LEDES is a
            standard format for legal invoicing.
            For information on the hell-spawn that is the LEDES format see <a href="https://ledes.org/ledes-98b-format"
                target="_blank">LEDES Format</a>.
            LEDES is a text, pipe-delimited format. It was designed by lawyers, which explains a lot. When you click
            "Generate LEDES File" the program will allow you to save your LEDES file.</p>

        <form id="ledesForm" class="mb-4">
            <div class="row mb-3">
                <div class="col-md-3">
                    <p><strong>Lines Total:</strong> <span id="LINE_ITEM_NUMBER" class="badge bg-secondary">0</span></p>
                </div>
                <div class="col-md-3">
                    <label for="INVOICE_TOTAL" class="form-label">Invoice Total:</label>
                    <input type="text" class="form-control" id="INVOICE_TOTAL" name="INVOICE_TOTAL" required>
                </div>
                <div class="col-md-6">
                    <p><strong>Invoice Total (Running):</strong> <span id="INVOICE_TOTAL_CALC"
                            class="badge bg-primary">0</span></p>
                </div>
            </div>

            <h4 class="mb-3">Invoice Information</h4>
            <div class="row g-3">
                <div class="col-md-3">
                    <label for="INVOICE_NUMBER" class="form-label">Invoice Number:</label>
                    <input type="text" class="form-control" id="INVOICE_NUMBER" name="INVOICE_NUMBER" required>
                </div>
                <div class="col-md-3">
                    <label for="INVOICE_DATE" class="form-label">Invoice Date:</label>
                    <input type="date" class="form-control" id="INVOICE_DATE" name="INVOICE_DATE" required>
                </div>
                <div class="col-md-3">
                    <label for="CLIENT_ID" class="form-label">Client ID:</label>
                    <input type="text" class="form-control" id="CLIENT_ID" name="CLIENT_ID" required>
                </div>
                <div class="col-md-3">
                    <label for="CLIENT_MATTER_ID" class="form-label">Client Matter ID:</label>
                    <input type="text" class="form-control" id="CLIENT_MATTER_ID" name="CLIENT_MATTER_ID" required>
                </div>
                <div class="col-md-3">
                    <label for="LAW_FIRM_MATTER_ID" class="form-label">Law Firm Matter:</label>
                    <input type="text" class="form-control" id="LAW_FIRM_MATTER_ID" name="LAW_FIRM_MATTER_ID" required>
                </div>
                <div class="col-md-3">
                    <label for="LAW_FIRM_ID" class="form-label">Law Firm ID (EIN):</label>
                    <input type="text" class="form-control" id="LAW_FIRM_ID" name="LAW_FIRM_ID" required>
                </div>
                <div class="col-md-3">
                    <label for="BILLING_START_DATE" class="form-label">Billing Start Date:</label>
                    <input type="date" class="form-control" id="BILLING_START_DATE" name="BILLING_START_DATE" required>
                </div>
                <div class="col-md-3">
                    <label for="BILLING_END_DATE" class="form-label">Billing End Date:</label>
                    <input type="date" class="form-control" id="BILLING_END_DATE" name="BILLING_END_DATE" required>
                </div>
                <div class="col-12">
                    <label for="INVOICE_DESCRIPTION" class="form-label">Invoice Description:</label>
                    <input type="text" class="form-control" id="INVOICE_DESCRIPTION" name="INVOICE_DESCRIPTION"
                        value="Legal Services">
                </div>
            </div>

            <h4 class="mt-4 mb-3">Line Items</h4>
            <div id="lineItemsContainer"></div>
            <button type="button" class="btn btn-secondary mt-2" onclick="addLineItem()">Add Line Item</button>

            <div class="mt-4">
                <button type="button" class="btn btn-success" onclick="generateLEDESFile()">Generate LEDES File</button>
            </div>
        </form>
    </div>
    <script src="https://js.puter.com/v2/"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let lineItems = [];
        let savedData = {};

        async function initializeApp() {
            await loadSavedData();
            setDefaults();
            addLineItem();
        }

        async function loadSavedData() {
            try {
                const data = await puter.kv.get('ledesConverterData');
                if (data) {
                    savedData = JSON.parse(data);
                    Object.keys(savedData).forEach(key => {
                        const element = document.getElementById(key);
                        if (element) {
                            element.value = savedData[key];
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading saved data:', error);
            }
        }

        async function saveData() {
            const formElements = document.querySelectorAll('#ledesForm input, #ledesForm select');
            formElements.forEach(element => {
                savedData[element.id] = element.value;
            });
            try {
                await puter.kv.set('ledesConverterData', JSON.stringify(savedData));
            } catch (error) {
                console.error('Error saving data:', error);
            }
        }

        function setDefaults() {
            const today = new Date();
            if (!document.getElementById("INVOICE_DATE").value) {
                document.getElementById("INVOICE_DATE").value = today.toISOString().split('T')[0];
            }
            if (!document.getElementById("BILLING_START_DATE").value || !document.getElementById("BILLING_END_DATE").value) {
                getPreviousMonthDates(today);
            }
        }

        function addLineItem() {
            const lineItem = {
                LINE_ITEM_DATE: "",
                TIMEKEEPER_NAME: "",
                TIMEKEEPER_ID: "",
                TIMEKEEPER_CLASSIFICATION: "PARTNR",
                LINE_ITEM_NUMBER_OF_UNITS: "",
                LINE_ITEM_DESCRIPTION: "",
                LINE_ITEM_UNIT_COST: "",
                LINE_ITEM_TASK_CODE: "",
                LINE_ITEM_EXPENSE_CODE: "",
                LINE_ITEM_ACTIVITY_CODE: "",
                EXP_FEE_INV_ADJ_TYPE: "F",
                LINE_ITEM_ADJUSTMENT_AMOUNT: "0"
            };
            lineItems.push(lineItem);
            renderLineItems();
        }

        function renderLineItems() {
            const container = document.getElementById('lineItemsContainer');
            container.innerHTML = '';
            lineItems.forEach((item, index) => {
                const lineItemHtml = createLineItemHtml(item, index);
                container.innerHTML += lineItemHtml;
            });
        }

        function createLineItemHtml(item, index) {
            return `
                <div class="line-item">
                    <h5>Line Item ${index + 1}</h5>
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="LINE_ITEM_DATE_${index}" class="form-label">Line Item Date:</label>
                            <input type="date" class="form-control" id="LINE_ITEM_DATE_${index}" value="${item.LINE_ITEM_DATE}" onchange="updateLineItem(${index}, 'LINE_ITEM_DATE', this.value)" required>
                        </div>
                        <div class="col-md-3">
                            <label for="TIMEKEEPER_NAME_${index}" class="form-label">Timekeeper Name:</label>
                            <input type="text" class="form-control" id="TIMEKEEPER_NAME_${index}" value="${item.TIMEKEEPER_NAME}" onchange="updateLineItem(${index}, 'TIMEKEEPER_NAME', this.value)" required>
                        </div>
                        <div class="col-md-3">
                            <label for="TIMEKEEPER_ID_${index}" class="form-label">Timekeeper ID:</label>
                            <input type="text" class="form-control" id="TIMEKEEPER_ID_${index}" value="${item.TIMEKEEPER_ID}" onchange="updateLineItem(${index}, 'TIMEKEEPER_ID', this.value)" required>
                        </div>
                        <div class="col-md-3">
                            <label for="TIMEKEEPER_CLASSIFICATION_${index}" class="form-label">Timekeeper Class:</label>
                            <input type="text" class="form-control" id="TIMEKEEPER_CLASSIFICATION_${index}" value="${item.TIMEKEEPER_CLASSIFICATION}" onchange="updateLineItem(${index}, 'TIMEKEEPER_CLASSIFICATION', this.value)" required>
                        </div>
                        <div class="col-md-3">
                            <label for="LINE_ITEM_NUMBER_OF_UNITS_${index}" class="form-label">Line Item Units:</label>
                            <input type="number" class="form-control" id="LINE_ITEM_NUMBER_OF_UNITS_${index}" value="${item.LINE_ITEM_NUMBER_OF_UNITS}" onchange="updateLineItem(${index}, 'LINE_ITEM_NUMBER_OF_UNITS', this.value)" required>
                        </div>
                        <div class="col-9">
                            <label for="LINE_ITEM_DESCRIPTION_${index}" class="form-label">Description:</label>
                            <input type="text" class="form-control" id="LINE_ITEM_DESCRIPTION_${index}" value="${item.LINE_ITEM_DESCRIPTION}" onchange="updateLineItem(${index}, 'LINE_ITEM_DESCRIPTION', this.value)" required>
                        </div>
                        <div class="col-md-3">
                            <label for="LINE_ITEM_UNIT_COST_${index}" class="form-label">Line Item Unit Cost:</label>
                            <input type="number" class="form-control" id="LINE_ITEM_UNIT_COST_${index}" value="${item.LINE_ITEM_UNIT_COST}" onchange="updateLineItem(${index}, 'LINE_ITEM_UNIT_COST', this.value)" required>
                        </div>
                        <div class="col-md-3">
                            <label for="LINE_ITEM_TASK_CODE_${index}" class="form-label">Task Code (UTBMS):</label>
                            <input type="text" class="form-control" id="LINE_ITEM_TASK_CODE_${index}" value="${item.LINE_ITEM_TASK_CODE}" onchange="updateLineItem(${index}, 'LINE_ITEM_TASK_CODE', this.value)" required>
                        </div>
                        <div class="col-md-3">
                            <label for="LINE_ITEM_EXPENSE_CODE_${index}" class="form-label">Expense Code:</label>
                            <input type="text" class="form-control" id="LINE_ITEM_EXPENSE_CODE_${index}" value="${item.LINE_ITEM_EXPENSE_CODE}" onchange="updateLineItem(${index}, 'LINE_ITEM_EXPENSE_CODE', this.value)" required>
                        </div>
                        <div class="col-md-3">
                            <label for="LINE_ITEM_ACTIVITY_CODE_${index}" class="form-label">Activity Code:</label>
                            <input type="text" class="form-control" id="LINE_ITEM_ACTIVITY_CODE_${index}" value="${item.LINE_ITEM_ACTIVITY_CODE}" onchange="updateLineItem(${index}, 'LINE_ITEM_ACTIVITY_CODE', this.value)" required>
                        </div>
                        <div class="col-md-3">
                            <label for="EXP_FEE_INV_ADJ_TYPE_${index}" class="form-label">Expense(E)/Fee(F):</label>
                            <input type="text" class="form-control" id="EXP_FEE_INV_ADJ_TYPE_${index}" value="${item.EXP_FEE_INV_ADJ_TYPE}" onchange="updateLineItem(${index}, 'EXP_FEE_INV_ADJ_TYPE', this.value)" required>
                        </div>
                        <div class="col-md-3">
                            <label for="LINE_ITEM_ADJUSTMENT_AMOUNT_${index}" class="form-label">Adjustment Amount:</label>
                            <input type="number" class="form-control" id="LINE_ITEM_ADJUSTMENT_AMOUNT_${index}" value="${item.LINE_ITEM_ADJUSTMENT_AMOUNT}" onchange="updateLineItem(${index}, 'LINE_ITEM_ADJUSTMENT_AMOUNT', this.value)">
                        </div>
                    </div>
                </div>
            `;
        }

        function updateLineItem(index, field, value) {
            lineItems[index][field] = value;
            updateTotals();
        }

        function updateTotals() {
            let total = 0;
            lineItems.forEach(item => {
                const units = parseFloat(item.LINE_ITEM_NUMBER_OF_UNITS) || 0;
                const cost = parseFloat(item.LINE_ITEM_UNIT_COST) || 0;
                const adjustmentAmount = parseFloat(item.LINE_ITEM_ADJUSTMENT_AMOUNT) || 0;
                total += (units * cost) + adjustmentAmount;
            });
            document.getElementById("INVOICE_TOTAL_CALC").textContent = total.toFixed(2);
            document.getElementById("LINE_ITEM_NUMBER").textContent = lineItems.length;
        }

        function getPreviousMonthDates(date) {
            const firstDayOfGivenMonth = new Date(date.getFullYear(), date.getMonth(), 1);
            const lastDayOfPreviousMonth = new Date(firstDayOfGivenMonth);
            lastDayOfPreviousMonth.setDate(lastDayOfPreviousMonth.getDate() - 1);
            document.getElementById("BILLING_END_DATE").value = lastDayOfPreviousMonth.toISOString().split('T')[0];

            const firstDayOfPreviousMonth = new Date(lastDayOfPreviousMonth.getFullYear(), lastDayOfPreviousMonth.getMonth(), 1);
            document.getElementById("BILLING_START_DATE").value = firstDayOfPreviousMonth.toISOString().split('T')[0];
        }

        function formatDateYYYYMMDD(dateString) {
            return dateString.replace(/-/g, '');
        }

        function generateLEDESFile() {
            if (!validateForm()) {
                return;
            }

            let fileContents = "LEDES1998B|INVOICE_DATE|INVOICE_NUMBER|CLIENT_ID|LAW_FIRM_MATTER_ID|INVOICE_TOTAL|BILLING_START_DATE|BILLING_END_DATE|INVOICE_DESCRIPTION|LINE_ITEM_NUMBER|EXP/FEE/INV_ADJ_TYPE|LINE_ITEM_NUMBER_OF_UNITS|LINE_ITEM_ADJUSTMENT_AMOUNT|LINE_ITEM_TOTAL|LINE_ITEM_DATE|LINE_ITEM_TASK_CODE|LINE_ITEM_EXPENSE_CODE|LINE_ITEM_ACTIVITY_CODE|TIMEKEEPER_ID|LINE_ITEM_DESCRIPTION|LAW_FIRM_ID|LINE_ITEM_UNIT_COST|TIMEKEEPER_NAME|TIMEKEEPER_CLASSIFICATION|CLIENT_MATTER_ID[]\n";

            const invoiceTotal = parseFloat(document.getElementById("INVOICE_TOTAL").value);
            let runningTotal = 0;

            lineItems.forEach((item, index) => {
                const lineItemTotal = (parseFloat(item.LINE_ITEM_NUMBER_OF_UNITS) * parseFloat(item.LINE_ITEM_UNIT_COST)) + parseFloat(item.LINE_ITEM_ADJUSTMENT_AMOUNT);
                runningTotal += lineItemTotal;

                const delimiter = "|";
                const file_delimiter = "[]";
                let printLine = [
                    formatDateYYYYMMDD(document.getElementById("INVOICE_DATE").value),
                    document.getElementById("INVOICE_NUMBER").value,
                    document.getElementById("CLIENT_ID").value,
                    document.getElementById("LAW_FIRM_MATTER_ID").value,
                    invoiceTotal.toFixed(2),
                    formatDateYYYYMMDD(document.getElementById("BILLING_START_DATE").value),
                    formatDateYYYYMMDD(document.getElementById("BILLING_END_DATE").value),
                    document.getElementById("INVOICE_DESCRIPTION").value,
                    index + 1,
                    item.EXP_FEE_INV_ADJ_TYPE,
                    item.LINE_ITEM_NUMBER_OF_UNITS,
                    item.LINE_ITEM_ADJUSTMENT_AMOUNT,
                    lineItemTotal.toFixed(2),
                    formatDateYYYYMMDD(item.LINE_ITEM_DATE),
                    item.LINE_ITEM_TASK_CODE,
                    item.LINE_ITEM_EXPENSE_CODE,
                    item.LINE_ITEM_ACTIVITY_CODE,
                    item.TIMEKEEPER_ID,
                    item.LINE_ITEM_DESCRIPTION,
                    document.getElementById("LAW_FIRM_ID").value,
                    item.LINE_ITEM_UNIT_COST,
                    item.TIMEKEEPER_NAME,
                    item.TIMEKEEPER_CLASSIFICATION,
                    document.getElementById("CLIENT_MATTER_ID").value
                ].join(delimiter);

                fileContents += printLine + file_delimiter + "\n";
            });

            if (Math.abs(runningTotal - invoiceTotal) > 0.01) {
                alert("Warning: The sum of line items does not match the invoice total. Please check your entries.");
            }

            saveData();
            downloadFile(fileContents);
        }

        function validateForm() {
            const billingStartDate = new Date(document.getElementById("BILLING_START_DATE").value);
            const billingEndDate = new Date(document.getElementById("BILLING_END_DATE").value);

            for (let i = 0; i < lineItems.length; i++) {
                const lineItemDate = new Date(lineItems[i].LINE_ITEM_DATE);
                if (lineItemDate < billingStartDate || lineItemDate > billingEndDate) {
                    alert(`Line item ${i + 1} date is outside the billing period. Please check your entries.`);
                    return false;
                }
            }

            return true;
        }

        function downloadFile(contents) {
            const blob = new Blob([contents], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'ledes_98b_output.txt';
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            alert("Your LEDES file has been generated and downloaded. Thanks for using the Bananafoot LEDES conversion program. Now go and re-think your life choices.");
        }

        window.onload = initializeApp;
    </script>
</body>

</html>